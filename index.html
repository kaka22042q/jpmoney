<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ¾ 2035 æ—¥æœ¬ç’°å³¶å­˜æ¬¾å¤§ä½œæˆ°</title>
    <style>
        :root { 
            --cat-main: #FFB7B2; --cat-bg: #fffaf0; --cat-dark: #5D4037; 
            --cat-gray: #D7CCC8; --cat-red: #ff7675; --cat-green: #55efc4; 
            --cat-blue: #74b9ff; --cat-yellow: #ffeaa7; --accent: #FF748C;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, "Microsoft JhengHei", sans-serif; }
        body { background-color: var(--cat-bg); color: var(--cat-dark); margin: 0; padding: 0 0 120px 0; }
        .container { max-width: 480px; margin: 0 auto; padding: 15px; }
        
        .cat-card { background: #ffffff; border: 2.5px solid var(--cat-dark); box-shadow: 4px 4px 0px var(--cat-dark); border-radius: 20px; margin-bottom: 15px; padding: 15px; position: relative; }
        .prog-container { background: #eee; height: 22px; border-radius: 11px; border: 2px solid var(--cat-dark); overflow: hidden; margin: 8px 0; position: relative; }
        .prog-fill { height: 100%; transition: width 0.8s ease; background: var(--cat-main); }
        .prog-text { position: absolute; width: 100%; text-align: center; font-size: 11px; font-weight: 900; line-height: 18px; z-index: 5; color: var(--cat-dark); text-shadow: 1px 1px 0px rgba(255,255,255,0.5); }
        
        .nav-bar { position: fixed; bottom: 15px; left: 15px; right: 15px; background: white; border: 3px solid var(--cat-dark); display: flex; justify-content: space-around; padding: 10px; z-index: 1000; border-radius: 20px; box-shadow: 0 5px 0 var(--cat-gray); }
        .nav-item { border: none; background: none; flex: 1; display: flex; flex-direction: column; align-items: center; cursor: pointer; color: var(--cat-gray); }
        .nav-item.active { color: var(--cat-dark); }
        .nav-icon { font-size: 24px; }
        .nav-text { font-size: 10px; font-weight: bold; }

        .page { display: none; animation: fadeIn 0.2s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        input, select, textarea { width: 100%; padding: 12px; border: 2.2px solid var(--cat-gray); border-radius: 12px; outline: none; font-size: 14px; background: white; }
        textarea { height: 120px; resize: none; line-height: 1.5; }
        .btn-main { background: var(--cat-main); border: 2.5px solid var(--cat-dark); box-shadow: 0 4px 0px var(--cat-dark); font-weight: bold; color: white; border-radius: 15px; padding: 15px; width: 100%; font-size: 16px; cursor: pointer; margin-top: 10px; }
        
        .rolling-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
        .budget-box { background: #fdfcf0; border: 1.5px solid #d4c4a8; border-radius: 15px; padding: 12px; margin-bottom: 10px; }
        .budget-title { font-weight: bold; font-size: 14px; margin-bottom: 5px; display: flex; justify-content: space-between; }
        .budget-detail { display: grid; grid-template-columns: 1fr 1fr; font-size: 11px; color: #7a6e5a; gap: 5px; }
        .budget-result { grid-column: span 2; border-top: 1px dashed #d4c4a8; margin-top: 5px; padding-top: 5px; display: flex; justify-content: space-between; align-items: center; }
        .allowance-amt { font-size: 18px; font-weight: 900; }
        .pos { color: var(--cat-green); }
        .neg { color: var(--cat-red); }

        .log-item { background: #f9f9f9; border-left: 5px solid var(--cat-blue); padding: 12px; margin-bottom: 10px; border-radius: 0 15px 15px 0; position: relative; }
        .log-header { display: flex; justify-content: space-between; font-weight: bold; padding-right: 30px; }
        .log-note { color: #666; font-size: 12px; white-space: pre-wrap; margin-top: 8px; border-top: 1px dashed #ddd; padding-top: 8px; }
        .log-del { position: absolute; top: 12px; right: 10px; color: #ccc; border: none; background: none; font-size: 18px; cursor: pointer; padding: 0 5px; }
        .log-del:hover { color: var(--cat-red); }

        .no-result { text-align: center; color: #bbb; padding: 30px 10px; font-style: italic; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; width: 90%; max-height: 90vh; overflow-y: auto; padding: 20px; border-radius: 25px; border: 3px solid var(--cat-dark); }
    </style>
</head>
<body>

<div id="settingsModal" class="modal">
    <div class="modal-content">
        <h3>âš™ï¸ ç›®æ¨™è¨­å®š</h3>
        <label>åŒ¯ç‡ (1 JPY = ? TWD)</label><input type="number" id="set_rate" step="0.001" style="margin-bottom:15px;">
        <label>å¹´åº¦å°å¹£ç›®æ¨™ ($)</label><input type="number" id="set_t1_goal" style="margin-bottom:10px;">
        <label>å¹´åº¦æ—¥å¹£ç›®æ¨™ (Â¥)</label><input type="number" id="set_j1_goal" style="margin-bottom:15px;">
        <button onclick="updateSettings()" class="btn-main">å„²å­˜è¨­å®š</button>
        <button onclick="closeModal('settingsModal')" style="background:none; border:none; width:100%; margin-top:10px; color:gray;">å–æ¶ˆ</button>
    </div>
</div>

<div id="tripModal" class="modal">
    <div class="modal-content">
        <h3>ğŸ“… é–‹å•Ÿæ–°è¡Œç¨‹è¨˜å¸³æœ¬</h3>
        <input type="text" id="nt_name" placeholder="è¡Œç¨‹åç¨± (å¦‚: 90å¤©ç’°å³¶æŒ‘æˆ°)" style="margin-bottom:10px;">
        <div style="display:flex; gap:5px; margin-bottom:15px;"><input type="date" id="nt_start"><input type="date" id="nt_end"></div>
        <p style="font-size:12px; font-weight:bold;">ğŸ’° æ—¥å¹£åˆ†é …ç¸½é ç®—ï¼š</p>
        <div style="display:grid; gap:8px;">
            <div style="display:flex; align-items:center; gap:8px;"><span>ğŸ½ï¸</span><input type="number" class="cat-goal" data-cat="é£²é£Ÿ" placeholder="é£²é£Ÿç¸½é¡"></div>
            <div style="display:flex; align-items:center; gap:8px;"><span>ğŸ </span><input type="number" class="cat-goal" data-cat="ä½å®¿" placeholder="ä½å®¿ç¸½é¡"></div>
            <div style="display:flex; align-items:center; gap:8px;"><span>ğŸšƒ</span><input type="number" class="cat-goal" data-cat="äº¤é€š" placeholder="äº¤é€šç¸½é¡"></div>
            <div style="display:flex; align-items:center; gap:8px;"><span>ğŸ›ï¸</span><input type="number" class="cat-goal" data-cat="è³¼ç‰©" placeholder="è³¼ç‰©ç¸½é¡"></div>
            <div style="display:flex; align-items:center; gap:8px;"><span>ğŸŒ€</span><input type="number" class="cat-goal" data-cat="å…¶ä»–" placeholder="å…¶ä»–ç¸½é¡"></div>
        </div>
        <button onclick="saveNewTrip()" class="btn-main">ç¢ºèªå»ºç«‹è¡Œç¨‹</button>
        <button onclick="closeModal('tripModal')" style="background:none; border:none; width:100%; margin-top:10px; color:gray;">å–æ¶ˆ</button>
    </div>
</div>

<div class="container">
    <div id="page-home" class="page active">
        <div style="display: flex; justify-content: space-between; align-items: center;"><h1 style="color: var(--accent); margin: 10px 0;">ğŸ¾ å¤¢æƒ³å­˜æ¬¾å¤§ä½œæˆ°</h1><button onclick="openModal('settingsModal')" style="background:none; border:none; font-size: 22px;">âš™ï¸</button></div>
        <div class="cat-card" style="background: var(--cat-dark); color: white; text-align: center;">
            <div id="totalAssets" style="font-size: 28px; font-weight: 900; color: var(--cat-yellow); text-align:center;">$ --</div>
            <div style="font-size: 11px; margin-top: 8px; display:flex; justify-content:space-between; padding:0 10px;">
                <span>å‰©é¤˜ <strong id="mLeft">--</strong> æœˆ</span><span>åŒ¯ç‡ 1: <strong id="showRate">--</strong></span>
            </div>
        </div>
        <div id="jarList"></div>
        
        <div class="cat-card" style="background: var(--cat-yellow);">
            <h3 style="margin:0 0 10px 0">ğŸ¼ é¤µé£Ÿå­˜æ¬¾ç½</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                <div><small>å¹´åº¦å°å¹£ ($)</small><input type="number" id="in_t1" placeholder="0"></div>
                <div><small>å¹´åº¦æ—¥å¹£ (Â¥)</small><input type="number" id="in_j1" placeholder="0"></div>
                <div><small>ç’°å³¶ibrain ($)</small><input type="number" id="in_t2" placeholder="0"></div>
                <div><small>ç’°å³¶ç¾éˆ” (Â¥)</small><input type="number" id="in_j2" placeholder="0"></div>
            </div>
            <button onclick="saveSavings()" class="btn-main">ç¢ºèªå­˜å…¥ ğŸŸ</button>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button onclick="exportData()" style="flex:1; padding:10px; border-radius:15px; border:2px solid var(--cat-dark); background:#fff; font-size:12px; font-weight:bold;">ğŸ“¦ åŒ¯å‡ºå‚™ä»½</button>
            <button onclick="document.getElementById('importFile').click()" style="flex:1; padding:10px; border-radius:15px; border:2px solid var(--cat-dark); background:#fff; font-size:12px; font-weight:bold;">ğŸ“¥ åŒ¯å…¥å‚™ä»½</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(event)">
        </div>
    </div>

    <div id="page-trips" class="page">
        <h2 class="text-center" style="color:var(--cat-blue)">ğŸ“… è¡Œç¨‹é ç®—æ—¥èªŒ</h2>
        <div style="margin-bottom:15px;">
            <select id="view-trip-select" onchange="renderTripLog()" style="margin-bottom:10px;"></select>
            <input type="text" id="log-search" oninput="renderTripLog()" placeholder="ğŸ” æœå°‹è¨˜å¸³å‚™è¨»æˆ–åˆ†é¡...">
        </div>
        <div id="active-trip-status"></div>
        <div id="active-trip-logs"></div>
        <button class="btn-main" onclick="openModal('tripModal')" style="background:var(--cat-blue);">+ æ–°å¢è¡Œç¨‹è¨˜å¸³æœ¬</button>
    </div>

    <div id="page-budget" class="page">
        <h2 class="text-center">ğŸ—¾ ç’°å³¶è¦åŠƒ (å…¨æ—¥å¹£)</h2>
        <div class="cat-card" id="budgetList"></div>
        <div class="cat-card">
            <h3>+ æ–°å¢é …ç›® (Â¥)</h3>
            <input type="text" id="b-name" placeholder="é …ç›®åç¨±" style="margin-bottom:10px;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px;"><input type="number" id="b-price" placeholder="å–®åƒ¹ (Â¥)"><input type="number" id="b-qty" placeholder="æ•¸é‡"></div>
            <button onclick="addBudget()" class="btn-main" style="background:var(--cat-green)">åŠ å…¥æ¸…å–® ğŸŸ</button>
        </div>
    </div>

    <div id="page-daily" class="page">
        <h2 class="text-center">âœï¸ æ”¯å‡ºè¨˜å¸³</h2>
        <div class="cat-card">
            <select id="exp-trip" style="margin-bottom:15px;"></select>
            <select id="exp-cate" style="margin-bottom:10px;">
                <option value="é£²é£Ÿ">ğŸ½ï¸ é£²é£Ÿ</option><option value="ä½å®¿">ğŸ  ä½å®¿</option><option value="äº¤é€š">ğŸšƒ äº¤é€š</option><option value="è³¼ç‰©">ğŸ è³¼ç‰©</option><option value="å…¶ä»–">ğŸŒ€ å…¶ä»–</option>
            </select>
            <textarea id="exp-note" placeholder="è©³ç´°è³¼è²·æ¸…å–®..."></textarea>
            <div class="input-grid" style="margin-top:10px;"><input type="number" id="exp-amt" placeholder="é‡‘é¡"><select id="exp-acc"><option value="j2">ç’°å³¶æ—¥å¹£ (Â¥)</option><option value="t2">ç’°å³¶å°å¹£ ($)</option><option value="j1">å¹´åº¦æ—¥å¹£ (Â¥)</option><option value="t1">å¹´åº¦å°å¹£ ($)</option></select></div>
            <input type="date" id="exp-date">
            <button onclick="saveExpense()" class="btn-main" style="background:var(--cat-red);">ç¢ºèªæ”¯å‡º ğŸ¾</button>
        </div>
    </div>
</div>

<nav class="nav-bar">
    <button class="nav-item active" onclick="showPage('home', this)"><span class="nav-icon">ğŸ </span><div class="nav-text">ä¸»é </div></button>
    <button class="nav-item" onclick="showPage('trips', this)"><span class="nav-icon">ğŸ“Š</span><div class="nav-text">æ—¥èªŒ</div></button>
    <button class="nav-item" onclick="showPage('budget', this)"><span class="nav-icon">ğŸ—¾</span><div class="nav-text">è¦åŠƒ</div></button>
    <button class="nav-item" onclick="showPage('daily', this)"><span class="nav-icon">âœï¸</span><div class="nav-text">è¨˜å¸³</div></button>
</nav>

<script>
    const START_DATE_FIXED = new Date(2026, 0, 1), END_DATE_FIXED = new Date(2035, 9, 1);
    const DB_KEY = 'trip_2035_final_v12';

    let store = JSON.parse(localStorage.getItem(DB_KEY)) || {
        balances: { t1:0, j1:0, t2:0, j2:0 },
        annualGoals: { t1: 108000, j1: 500000 },
        fxRate: 0.22,
        budgetItems: [],
        trips: []
    };

    function save() { localStorage.setItem(DB_KEY, JSON.stringify(store)); }

    function showPage(pId, el) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('page-' + pId).classList.add('active');
        if(el) el.classList.add('active');
        if(pId === 'home') renderHome();
        if(pId === 'trips') { initTripSelects(); renderTripLog(); }
        if(pId === 'budget') renderBudgetBook();
        if(pId === 'daily') initDailySelects();
    }

    function renderHome() {
        const now = new Date();
        const mLeft = Math.max(0, (END_DATE_FIXED.getFullYear() - now.getFullYear()) * 12 + (END_DATE_FIXED.getMonth() - now.getMonth()));
        document.getElementById('mLeft').innerText = mLeft;
        document.getElementById('showRate').innerText = store.fxRate;
        const totalJPYBudget = store.budgetItems.reduce((s,i) => s + (i.price * i.qty), 0);
        const goalJ2 = Math.round(totalJPYBudget * 0.5), goalT2 = Math.round((totalJPYBudget * 0.5) * store.fxRate);
        const totalTWD = store.balances.t1 + store.balances.t2 + (store.balances.j1 + store.balances.j2) * store.fxRate;
        document.getElementById('totalAssets').innerText = `$ ${Math.round(totalTWD).toLocaleString()}`;
        const configs = [
            { id:'t1', name:'å¹´åº¦å°å¹£', goal: store.annualGoals.t1, u:'$', cyc:12, pass: now.getMonth()+1 },
            { id:'j1', name:'å¹´åº¦æ—¥å¹£', goal: store.annualGoals.j1, u:'Â¥', cyc:12, pass: now.getMonth()+1 },
            { id:'t2', name:'ç’°å³¶å°(ib)', goal: goalT2, u:'$', cyc:117, pass: Math.max(1,(now.getFullYear()-2026)*12+now.getMonth()+1) },
            { id:'j2', name:'ç’°å³¶æ—¥(ç¾)', goal: goalJ2, u:'Â¥', cyc:117, pass: Math.max(1,(now.getFullYear()-2026)*12+now.getMonth()+1) }
        ];
        const list = document.getElementById('jarList'); list.innerHTML = "";
        configs.forEach(cfg => {
            const cur = store.balances[cfg.id], pct = Math.min(Math.round(cur/cfg.goal*100), 100);
            const monthly = Math.round(cfg.goal / cfg.cyc);
            const diff = cur - (monthly * cfg.pass);
            list.innerHTML += `<div class="cat-card" style="padding:12px;">
                <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:12px;"><span>${cfg.name}</span><span>${cfg.u}${cur.toLocaleString()}</span></div>
                <div class="prog-container"><div class="prog-fill" style="width:${pct}%; background:${diff>=0?'var(--cat-green)':'var(--cat-main)'}"></div><div class="prog-text">${pct}% (${cfg.u}${cur.toLocaleString()})</div></div>
                <div style="display:flex; justify-content:space-between; font-size:11px;">
                    <span>æœˆå»ºè­°: ${cfg.u}${monthly.toLocaleString()}</span>
                    <span style="color:${diff>=0?'#27ae60':'#e74c3c'}; font-weight:bold;">${diff>=0?'âœ“é ˜å…ˆ':'è½å¾Œ'} ${cfg.u}${Math.abs(diff).toLocaleString()}</span>
                </div></div>`;
        });
    }

    function renderTripLog() {
        const tid = document.getElementById('view-trip-select').value;
        const q = document.getElementById('log-search').value.toLowerCase().trim();
        if(!tid) return;
        const trip = store.trips.find(t => t.id == tid);
        const today = new Date(); today.setHours(0,0,0,0);
        const start = new Date(trip.start), end = new Date(trip.end);
        const totalDays = Math.max(1, Math.ceil((end - start) / 86400000) + 1);
        let daysPassed = Math.ceil((today - start) / 86400000) + 1;
        if(daysPassed < 1) daysPassed = 1; else if(daysPassed > totalDays) daysPassed = totalDays;

        let html = `<div class="cat-card" style="background:#f0f7ff; border-color:var(--cat-blue)">
            <div style="display:flex; justify-content:space-between;"><strong>ğŸ“ ${trip.name}</strong><button onclick="deleteTripSet('${trip.id}')" style="background:none; border:none; color:red; font-size:12px;">[åˆªé™¤è¡Œç¨‹]</button></div>
            <div style="font-size:11px; color:#555;">ğŸ“… ${trip.start} ~ ${trip.end} (${totalDays}å¤©)</div>
            <div style="font-size:12px; font-weight:bold; margin-top:10px;">â­ ä»Šæ—¥å¯ç”¨é¡åº¦ (ç¬¬ ${daysPassed} å¤©)</div>`;

        for(let cat in trip.categoryBudgets) {
            const goal = trip.categoryBudgets[cat];
            if(goal <= 0) continue;
            const avg = Math.round(goal / totalDays);
            const spentUntilYesterday = (trip.logs || []).filter(l => l.cate === cat && new Date(l.date) < today).reduce((s,l)=>s+l.amt, 0);
            const yestBal = (avg * (daysPassed - 1)) - spentUntilYesterday;
            const todayAllowed = avg + yestBal;

            html += `<div class="budget-box">
                <div class="budget-title"><span>${cat}</span><small>å¹³å‡ Â¥${avg}/æ—¥</small></div>
                <div class="budget-detail"><span>æ˜¨æ—¥ç´¯è¨ˆçµé¤˜:</span><span class="${yestBal>=0?'pos':'neg'}">${yestBal>=0?'+':''}${yestBal.toLocaleString()}</span><span>ä»Šæ—¥åŸºç¤é¡åº¦:</span><span>+ ${avg.toLocaleString()}</span></div>
                <div class="budget-result"><strong>ä»Šæ—¥å¯ç”¨ç¸½é¡:</strong><span class="allowance-amt ${todayAllowed>=0?'pos':'neg'}">Â¥ ${todayAllowed.toLocaleString()}</span></div>
            </div>`;
        }
        document.getElementById('active-trip-status').innerHTML = html + `</div>`;

        const logs = (trip.logs || []).filter(l => 
            l.note.toLowerCase().includes(q) || 
            l.cate.toLowerCase().includes(q) ||
            l.date.includes(q)
        ).sort((a,b) => new Date(b.date) - new Date(a.date));

        const logContainer = document.getElementById('active-trip-logs');
        if (logs.length === 0) {
            logContainer.innerHTML = `<div class="no-result">ğŸ” æ‰¾ä¸åˆ°ç›¸é—œç´€éŒ„å–µ...</div>`;
        } else {
            logContainer.innerHTML = logs.map((l) => `
                <div class="log-item">
                    <div class="log-header"><span>${l.date} [${l.cate}]</span><span>${l.amt.toLocaleString()}</span></div>
                    <button class="log-del" onclick="deleteLogItem('${trip.id}', ${l.id})">Ã—</button>
                    <div class="log-note">${l.note}</div>
                </div>`).join('');
        }
    }

    function deleteLogItem(tripId, logId) {
        if(!confirm("ç¢ºå®šè¦åˆªé™¤é€™ç­†è¨˜å¸³å—ï¼Ÿ")) return;
        const trip = store.trips.find(t => t.id == tripId);
        const logIdx = trip.logs.findIndex(l => l.id == logId);
        if(logIdx > -1) {
            const log = trip.logs[logIdx];
            store.balances[log.acc] += log.amt; 
            trip.logs.splice(logIdx, 1);
            save();
            renderTripLog();
            renderHome();
        }
    }

    function initTripSelects() { document.getElementById('view-trip-select').innerHTML = store.trips.map(t => `<option value="${t.id}">${t.name}</option>`).join(''); }
    function saveSavings() { ['t1','j1','t2','j2'].forEach(id => store.balances[id] += Number(document.getElementById('in_'+id).value) || 0); save(); renderHome(); ['t1','j1','t2','j2'].forEach(id => document.getElementById('in_'+id).value = ""); }
    function renderBudgetBook() {
        const area = document.getElementById('budgetList'); area.innerHTML = ""; let total = 0;
        store.budgetItems.forEach((item, idx) => { const sub = item.price * item.qty; total += sub; area.innerHTML += `<div class="rolling-row"><div>${item.name}<br><small>Â¥${item.price}x${item.qty}</small></div><div>Â¥${sub.toLocaleString()} <span onclick="delBud(${idx})" style="color:red;cursor:pointer;">Ã—</span></div></div>`; });
        const splitJ = Math.round(total * 0.5), splitT = Math.round(splitJ * store.fxRate);
        area.innerHTML += `<div style="margin-top:15px; padding:12px; background:#fff3e0; border-radius:10px; font-size:13px; border:1px solid #ffcc80;"><div style="color:#e65100; font-weight:bold;">æ—¥å¹£ç¸½è¨ˆï¼šÂ¥${total.toLocaleString()}</div><hr style="border:0; border-top:1px dashed #ffcc80; margin:8px 0;"><div style="display:flex; justify-content:space-between;"><span>ç’°å³¶æ—¥å¹£ (50%):</span><strong>Â¥${splitJ.toLocaleString()}</strong></div><div style="display:flex; justify-content:space-between;"><span>ç’°å³¶å°å¹£ (50%):</span><strong>$${splitT.toLocaleString()}</strong></div></div>`;
    }
    function addBudget() { const n=document.getElementById('b-name').value, p=Number(document.getElementById('b-price').value), q=Number(document.getElementById('b-qty').value); if(n && p) { store.budgetItems.push({name:n, price:p, qty:q}); save(); renderBudgetBook(); } }
    function delBud(idx) { store.budgetItems.splice(idx,1); save(); renderBudgetBook(); }
    function initDailySelects() { document.getElementById('exp-trip').innerHTML = store.trips.map(t => `<option value="${t.id}">${t.name}</option>`).join(''); document.getElementById('exp-date').valueAsDate = new Date(); }
    function saveExpense() {
        const tid = document.getElementById('exp-trip').value, aid = document.getElementById('exp-acc').value, amt = Number(document.getElementById('exp-amt').value), note = document.getElementById('exp-note').value, cate = document.getElementById('exp-cate').value, date = document.getElementById('exp-date').value;
        if(!tid || !amt) return alert("å¡«å¯«é‡‘é¡");
        const trip = store.trips.find(t => t.id == tid);
        trip.logs.unshift({ id:Date.now(), note, amt, acc:aid, date, cate });
        store.balances[aid] -= amt; save(); alert("å„²å­˜æˆåŠŸï¼"); showPage('trips');
    }
    function saveNewTrip() {
        const name = document.getElementById('nt_name').value, s = document.getElementById('nt_start').value, e = document.getElementById('nt_end').value;
        if(!name || !s || !e) return alert("è«‹å¡«å¯«åç¨±èˆ‡æ—¥æœŸ");
        const categoryBudgets = {}; document.querySelectorAll('.cat-goal').forEach(inp => categoryBudgets[inp.dataset.cat] = Number(inp.value) || 0);
        store.trips.push({ id:Date.now().toString(), name, start:s, end:e, categoryBudgets, logs:[] });
        save(); closeModal('tripModal'); renderTripLog();
    }
    function deleteTripSet(tid) { if(confirm("ç¢ºå®šåˆªé™¤æ­¤è¡Œç¨‹ï¼Ÿè³‡æ–™ç„¡æ³•å¾©åŸå–”ï¼")) { store.trips = store.trips.filter(t => t.id !== tid); save(); renderTripLog(); } }
    function openModal(id) { if(id==='settingsModal') { document.getElementById('set_rate').value=store.fxRate; document.getElementById('set_t1_goal').value=store.annualGoals.t1; document.getElementById('set_j1_goal').value=store.annualGoals.j1; } document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function updateSettings() { store.fxRate = Number(document.getElementById('set_rate').value); store.annualGoals.t1 = Number(document.getElementById('set_t1_goal').value); store.annualGoals.j1 = Number(document.getElementById('set_j1_goal').value); save(); closeModal('settingsModal'); renderHome(); }
    function exportData() { const blob = new Blob([JSON.stringify(store)], {type: "application/json"}); const dl = document.createElement('a'); dl.href = URL.createObjectURL(blob); dl.download = `2035å‚™ä»½.json`; dl.click(); }
    function importData(e) { const f = e.target.files[0]; if(!f) return; const r = new FileReader(); r.onload = (ev) => { store = JSON.parse(ev.target.result); save(); location.reload(); }; r.readAsText(f); }
    window.onload = () => { renderHome(); };
</script>
</body>
</html>
